import{S as he,o as f,u as ge,a as et,s as d,n as _,b as E,l as se,e as tt,r as xe}from"./types.js";import"./index.js";let st=(e,s=21)=>(t=s)=>{let n="",r=t;for(;r--;)n+=e[Math.random()*e.length|0];return n};var Te="vercel.ai.error",nt=Symbol.for(Te),Se,ot=class Ae extends Error{constructor({name:s,message:t,cause:n}){super(t),this[Se]=!0,this.name=s,this.cause=n}static isInstance(s){return Ae.hasMarker(s,Te)}static hasMarker(s,t){const n=Symbol.for(t);return s!=null&&typeof s=="object"&&n in s&&typeof s[n]=="boolean"&&s[n]===!0}toJSON(){return{name:this.name,message:this.message}}};Se=nt;var I=ot,ne="AI_APICallError",Oe=`vercel.ai.error.${ne}`,rt=Symbol.for(Oe),Ne,R=class extends I{constructor({message:e,url:s,requestBodyValues:t,statusCode:n,responseHeaders:r,responseBody:a,cause:i,isRetryable:o=n!=null&&(n===408||n===409||n===429||n>=500),data:l}){super({name:ne,message:e,cause:i}),this[Ne]=!0,this.url=s,this.requestBodyValues=t,this.statusCode=n,this.responseHeaders=r,this.responseBody=a,this.isRetryable=o,this.data=l}static isInstance(e){return I.hasMarker(e,Oe)}static isAPICallError(e){return e instanceof Error&&e.name===ne&&typeof e.url=="string"&&typeof e.requestBodyValues=="object"&&(e.statusCode==null||typeof e.statusCode=="number")&&(e.responseHeaders==null||typeof e.responseHeaders=="object")&&(e.responseBody==null||typeof e.responseBody=="string")&&(e.cause==null||typeof e.cause=="object")&&typeof e.isRetryable=="boolean"&&(e.data==null||typeof e.data=="object")}toJSON(){return{name:this.name,message:this.message,url:this.url,requestBodyValues:this.requestBodyValues,statusCode:this.statusCode,responseHeaders:this.responseHeaders,responseBody:this.responseBody,cause:this.cause,isRetryable:this.isRetryable,data:this.data}}};Ne=rt;var oe="AI_EmptyResponseBodyError",Pe=`vercel.ai.error.${oe}`,at=Symbol.for(Pe),$e,it=class extends I{constructor({message:e="Empty response body"}={}){super({name:oe,message:e}),this[$e]=!0}static isInstance(e){return I.hasMarker(e,Pe)}static isEmptyResponseBodyError(e){return e instanceof Error&&e.name===oe}};$e=at;function Re(e){return e==null?"unknown error":typeof e=="string"?e:e instanceof Error?e.message:JSON.stringify(e)}var re="AI_InvalidPromptError",je=`vercel.ai.error.${re}`,lt=Symbol.for(je),qe,ut=class extends I{constructor({prompt:e,message:s,cause:t}){super({name:re,message:`Invalid prompt: ${s}`,cause:t}),this[qe]=!0,this.prompt=e}static isInstance(e){return I.hasMarker(e,je)}static isInvalidPromptError(e){return e instanceof Error&&e.name===re&&prompt!=null}toJSON(){return{name:this.name,message:this.message,stack:this.stack,prompt:this.prompt}}};qe=lt;var ae="AI_InvalidResponseDataError",Me=`vercel.ai.error.${ae}`,ct=Symbol.for(Me),Je,ee=class extends I{constructor({data:e,message:s=`Invalid response data: ${JSON.stringify(e)}.`}){super({name:ae,message:s}),this[Je]=!0,this.data=e}static isInstance(e){return I.hasMarker(e,Me)}static isInvalidResponseDataError(e){return e instanceof Error&&e.name===ae&&e.data!=null}toJSON(){return{name:this.name,message:this.message,stack:this.stack,data:this.data}}};Je=ct;var ie="AI_JSONParseError",He=`vercel.ai.error.${ie}`,pt=Symbol.for(He),Ve,z=class extends I{constructor({text:e,cause:s}){super({name:ie,message:`JSON parsing failed: Text: ${e}.
Error message: ${Re(s)}`,cause:s}),this[Ve]=!0,this.text=e}static isInstance(e){return I.hasMarker(e,He)}static isJSONParseError(e){return e instanceof Error&&e.name===ie&&"text"in e&&typeof e.text=="string"}toJSON(){return{name:this.name,message:this.message,cause:this.cause,stack:this.stack,valueText:this.text}}};Ve=pt;var le="AI_LoadAPIKeyError",Be=`vercel.ai.error.${le}`,dt=Symbol.for(Be),Fe,K=class extends I{constructor({message:e}){super({name:le,message:e}),this[Fe]=!0}static isInstance(e){return I.hasMarker(e,Be)}static isLoadAPIKeyError(e){return e instanceof Error&&e.name===le}};Fe=dt;var ue="AI_TooManyEmbeddingValuesForCallError",Le=`vercel.ai.error.${ue}`,mt=Symbol.for(Le),Ue,ht=class extends I{constructor(e){super({name:ue,message:`Too many values for a single embedding call. The ${e.provider} model "${e.modelId}" can only embed up to ${e.maxEmbeddingsPerCall} values per call, but ${e.values.length} values were provided.`}),this[Ue]=!0,this.provider=e.provider,this.modelId=e.modelId,this.maxEmbeddingsPerCall=e.maxEmbeddingsPerCall,this.values=e.values}static isInstance(e){return I.hasMarker(e,Le)}static isTooManyEmbeddingValuesForCallError(e){return e instanceof Error&&e.name===ue&&"provider"in e&&typeof e.provider=="string"&&"modelId"in e&&typeof e.modelId=="string"&&"maxEmbeddingsPerCall"in e&&typeof e.maxEmbeddingsPerCall=="number"&&"values"in e&&Array.isArray(e.values)}toJSON(){return{name:this.name,message:this.message,stack:this.stack,provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:this.values}}};Ue=mt;var ce="AI_TypeValidationError",De=`vercel.ai.error.${ce}`,gt=Symbol.for(De),Ge,ft=class pe extends I{constructor({value:s,cause:t}){super({name:ce,message:`Type validation failed: Value: ${JSON.stringify(s)}.
Error message: ${Re(t)}`,cause:t}),this[Ge]=!0,this.value=s}static isInstance(s){return I.hasMarker(s,De)}static wrap({value:s,cause:t}){return pe.isInstance(t)&&t.value===s?t:new pe({value:s,cause:t})}static isTypeValidationError(s){return s instanceof Error&&s.name===ce}toJSON(){return{name:this.name,message:this.message,cause:this.cause,stack:this.stack,value:this.value}}};Ge=gt;var W=ft,de="AI_UnsupportedFunctionalityError",Ke=`vercel.ai.error.${de}`,vt=Symbol.for(Ke),ze,A=class extends I{constructor({functionality:e}){super({name:de,message:`'${e}' functionality not supported.`}),this[ze]=!0,this.functionality=e}static isInstance(e){return I.hasMarker(e,Ke)}static isUnsupportedFunctionalityError(e){return e instanceof Error&&e.name===de&&typeof e.functionality=="string"}toJSON(){return{name:this.name,message:this.message,stack:this.stack,functionality:this.functionality}}};ze=vt;function yt(e){let s,t,n,r,a,i,o;return l(),{feed:m,reset:l};function l(){s=!0,t="",n=0,r=-1,a=void 0,i=void 0,o=""}function m(h){t=t?t+h:h,s&&_t(t)&&(t=t.slice(We.length)),s=!1;const p=t.length;let c=0,u=!1;for(;c<p;){u&&(t[c]===`
`&&++c,u=!1);let g=-1,v=r,b;for(let k=n;g<0&&k<p;++k)b=t[k],b===":"&&v<0?v=k-c:b==="\r"?(u=!0,g=k-c):b===`
`&&(g=k-c);if(g<0){n=p-c,r=v;break}else n=0,r=-1;y(t,c,v,g),c+=g+1}c===p?t="":c>0&&(t=t.slice(c))}function y(h,p,c,u){if(u===0){o.length>0&&(e({type:"event",id:a,event:i||void 0,data:o.slice(0,-1)}),o="",a=void 0),i=void 0;return}const g=c<0,v=h.slice(p,p+(g?u:c));let b=0;g?b=u:h[p+c+1]===" "?b=c+2:b=c+1;const k=p+b,S=u-b,C=h.slice(k,k+S).toString();if(v==="data")o+=C?"".concat(C,`
`):`
`;else if(v==="event")i=C;else if(v==="id"&&!C.includes("\0"))a=C;else if(v==="retry"){const x=parseInt(C,10);Number.isNaN(x)||e({type:"reconnect-interval",value:x})}}}const We=[239,187,191];function _t(e){return We.every((s,t)=>e.charCodeAt(t)===s)}class bt extends TransformStream{constructor(){let s;super({start(t){s=yt(n=>{n.type==="event"&&t.enqueue(n)})},transform(t){s.feed(t)}})}}var wt={};function F(...e){return e.reduce((s,t)=>({...s,...t??{}}),{})}function X(e){const s={};return e.headers.forEach((t,n)=>{s[n]=t}),s}var kt=({prefix:e="",size:s=7,alphabet:t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"}={})=>{const n=st(t,s);return r=>`${e}${n(r)}`},B=kt();function te(e){return e instanceof Error&&(e.name==="AbortError"||e.name==="TimeoutError")}function Et({apiKey:e,environmentVariableName:s,apiKeyParameterName:t="apiKey",description:n}){if(typeof e=="string")return e;if(e!=null)throw new K({message:`${n} API key must be a string.`});if(typeof process>"u")throw new K({message:`${n} API key is missing. Pass it using the '${t}' parameter. Environment variables is not supported in this environment.`});if(e=wt[s],e==null)throw new K({message:`${n} API key is missing. Pass it using the '${t}' parameter or the ${s} environment variable.`});if(typeof e!="string")throw new K({message:`${n} API key must be a string. The value of the ${s} environment variable is not a string.`});return e}var me=Symbol.for("vercel.ai.validator");function It(e){return{[me]:!0,validate:e}}function Ct(e){return typeof e=="object"&&e!==null&&me in e&&e[me]===!0&&"validate"in e}function xt(e){return Ct(e)?e:Tt(e)}function Tt(e){return It(s=>{const t=e.safeParse(s);return t.success?{success:!0,value:t.data}:{success:!1,error:t.error}})}function St({value:e,schema:s}){const t=Ye({value:e,schema:s});if(!t.success)throw W.wrap({value:e,cause:t.error});return t.value}function Ye({value:e,schema:s}){const t=xt(s);try{if(t.validate==null)return{success:!0,value:e};const n=t.validate(e);return n.success?n:{success:!1,error:W.wrap({value:e,cause:n.error})}}catch(n){return{success:!1,error:W.wrap({value:e,cause:n})}}}function At({text:e,schema:s}){try{const t=he.parse(e);return s==null?t:St({value:t,schema:s})}catch(t){throw z.isJSONParseError(t)||W.isTypeValidationError(t)?t:new z({text:e,cause:t})}}function Qe({text:e,schema:s}){try{const t=he.parse(e);return s==null?{success:!0,value:t}:Ye({value:t,schema:s})}catch(t){return{success:!1,error:z.isJSONParseError(t)?t:new z({text:e,cause:t})}}}function ke(e){try{return he.parse(e),!0}catch{return!1}}function Ot(e){return Object.fromEntries(Object.entries(e).filter(([s,t])=>t!=null))}var Nt=()=>globalThis.fetch,L=async({url:e,headers:s,body:t,failedResponseHandler:n,successfulResponseHandler:r,abortSignal:a,fetch:i})=>Pt({url:e,headers:{"Content-Type":"application/json",...s},body:{content:JSON.stringify(t),values:t},failedResponseHandler:n,successfulResponseHandler:r,abortSignal:a,fetch:i}),Pt=async({url:e,headers:s={},body:t,successfulResponseHandler:n,failedResponseHandler:r,abortSignal:a,fetch:i=Nt()})=>{try{const o=await i(e,{method:"POST",headers:Ot(s),body:t.content,signal:a}),l=X(o);if(!o.ok){let m;try{m=await r({response:o,url:e,requestBodyValues:t.values})}catch(y){throw te(y)||R.isAPICallError(y)?y:new R({message:"Failed to process error response",cause:y,statusCode:o.status,url:e,responseHeaders:l,requestBodyValues:t.values})}throw m.value}try{return await n({response:o,url:e,requestBodyValues:t.values})}catch(m){throw m instanceof Error&&(te(m)||R.isAPICallError(m))?m:new R({message:"Failed to process successful response",cause:m,statusCode:o.status,url:e,responseHeaders:l,requestBodyValues:t.values})}}catch(o){if(te(o))throw o;if(o instanceof TypeError&&o.message==="fetch failed"){const l=o.cause;if(l!=null)throw new R({message:`Cannot connect to API: ${l.message}`,cause:l,url:e,requestBodyValues:t.values,isRetryable:!0})}throw o}},$t=({errorSchema:e,errorToMessage:s,isRetryable:t})=>async({response:n,url:r,requestBodyValues:a})=>{const i=await n.text(),o=X(n);if(i.trim()==="")return{responseHeaders:o,value:new R({message:n.statusText,url:r,requestBodyValues:a,statusCode:n.status,responseHeaders:o,responseBody:i,isRetryable:t?.(n)})};try{const l=At({text:i,schema:e});return{responseHeaders:o,value:new R({message:s(l),url:r,requestBodyValues:a,statusCode:n.status,responseHeaders:o,responseBody:i,data:l,isRetryable:t?.(n,l)})}}catch{return{responseHeaders:o,value:new R({message:n.statusText,url:r,requestBodyValues:a,statusCode:n.status,responseHeaders:o,responseBody:i,isRetryable:t?.(n)})}}},Xe=e=>async({response:s})=>{const t=X(s);if(s.body==null)throw new it({});return{responseHeaders:t,value:s.body.pipeThrough(new TextDecoderStream).pipeThrough(new bt).pipeThrough(new TransformStream({transform({data:n},r){n!=="[DONE]"&&r.enqueue(Qe({text:n,schema:e}))}}))}},fe=e=>async({response:s,url:t,requestBodyValues:n})=>{const r=await s.text(),a=Qe({text:r,schema:e}),i=X(s);if(!a.success)throw new R({message:"Invalid JSON response",cause:a.error,statusCode:s.status,responseHeaders:i,responseBody:r,url:t,requestBodyValues:n});return{responseHeaders:i,value:a.value}},{btoa:Rt}=globalThis;function jt(e){let s="";for(let t=0;t<e.length;t++)s+=String.fromCodePoint(e[t]);return Rt(s)}function qt(e){return e?.replace(/\/$/,"")}function Mt({prompt:e,useLegacyFunctionCalling:s=!1}){const t=[];for(const{role:n,content:r}of e)switch(n){case"system":{t.push({role:"system",content:r});break}case"user":{if(r.length===1&&r[0].type==="text"){t.push({role:"user",content:r[0].text});break}t.push({role:"user",content:r.map(a=>{var i,o,l;switch(a.type){case"text":return{type:"text",text:a.text};case"image":return{type:"image_url",image_url:{url:a.image instanceof URL?a.image.toString():`data:${(i=a.mimeType)!=null?i:"image/jpeg"};base64,${jt(a.image)}`,detail:(l=(o=a.providerMetadata)==null?void 0:o.openai)==null?void 0:l.imageDetail}};case"file":throw new A({functionality:"File content parts in user messages"})}})});break}case"assistant":{let a="";const i=[];for(const o of r)switch(o.type){case"text":{a+=o.text;break}case"tool-call":{i.push({id:o.toolCallId,type:"function",function:{name:o.toolName,arguments:JSON.stringify(o.args)}});break}default:{const l=o;throw new Error(`Unsupported part: ${l}`)}}if(s){if(i.length>1)throw new A({functionality:"useLegacyFunctionCalling with multiple tool calls in one message"});t.push({role:"assistant",content:a,function_call:i.length>0?i[0].function:void 0})}else t.push({role:"assistant",content:a,tool_calls:i.length>0?i:void 0});break}case"tool":{for(const a of r)s?t.push({role:"function",name:a.toolName,content:JSON.stringify(a.result)}):t.push({role:"tool",tool_call_id:a.toolCallId,content:JSON.stringify(a.result)});break}default:{const a=n;throw new Error(`Unsupported role: ${a}`)}}return t}function Ee(e){var s,t;return(t=(s=e?.content)==null?void 0:s.map(({token:n,logprob:r,top_logprobs:a})=>({token:n,logprob:r,topLogprobs:a?a.map(({token:i,logprob:o})=>({token:i,logprob:o})):[]})))!=null?t:void 0}function Y(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var ve=f({error:f({message:d(),type:d().nullish(),param:et().nullish(),code:ge([d(),_()]).nullish()})}),U=$t({errorSchema:ve,errorToMessage:e=>e.error.message});function Q({id:e,model:s,created:t}){return{id:e??void 0,modelId:s??void 0,timestamp:t!=null?new Date(t*1e3):void 0}}var Jt=class{constructor(e,s,t){this.specificationVersion="v1",this.modelId=e,this.settings=s,this.config=t}get supportsStructuredOutputs(){return this.settings.structuredOutputs===!0}get defaultObjectGenerationMode(){return this.supportsStructuredOutputs?"json":"tool"}get provider(){return this.config.provider}get supportsImageUrls(){return!this.settings.downloadImages}getArgs({mode:e,prompt:s,maxTokens:t,temperature:n,topP:r,topK:a,frequencyPenalty:i,presencePenalty:o,stopSequences:l,responseFormat:m,seed:y,providerMetadata:h}){var p,c,u,g,v,b,k;const S=e.type,C=[];a!=null&&C.push({type:"unsupported-setting",setting:"topK"}),m!=null&&m.type==="json"&&m.schema!=null&&C.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format schema is not supported"});const x=this.settings.useLegacyFunctionCalling;if(x&&this.settings.parallelToolCalls===!0)throw new A({functionality:"useLegacyFunctionCalling with parallelToolCalls"});if(x&&this.settings.structuredOutputs===!0)throw new A({functionality:"structuredOutputs with useLegacyFunctionCalling"});const w={model:this.modelId,logit_bias:this.settings.logitBias,logprobs:this.settings.logprobs===!0||typeof this.settings.logprobs=="number"?!0:void 0,top_logprobs:typeof this.settings.logprobs=="number"?this.settings.logprobs:typeof this.settings.logprobs=="boolean"&&this.settings.logprobs?0:void 0,user:this.settings.user,parallel_tool_calls:this.settings.parallelToolCalls,max_tokens:t,temperature:n,top_p:r,frequency_penalty:i,presence_penalty:o,stop:l,seed:y,max_completion_tokens:(c=(p=h?.openai)==null?void 0:p.maxCompletionTokens)!=null?c:void 0,store:(g=(u=h?.openai)==null?void 0:u.store)!=null?g:void 0,metadata:(b=(v=h?.openai)==null?void 0:v.metadata)!=null?b:void 0,response_format:m?.type==="json"?{type:"json_object"}:void 0,messages:Mt({prompt:s,useLegacyFunctionCalling:x})};switch(Ie(this.modelId)&&(w.temperature=void 0,w.top_p=void 0,w.frequency_penalty=void 0,w.presence_penalty=void 0),S){case"regular":return{args:{...w,...Bt({mode:e,useLegacyFunctionCalling:x,structuredOutputs:this.settings.structuredOutputs})},warnings:C};case"object-json":return{args:{...w,response_format:this.settings.structuredOutputs===!0?{type:"json_schema",json_schema:{schema:e.schema,strict:!0,name:(k=e.name)!=null?k:"response",description:e.description}}:{type:"json_object"}},warnings:C};case"object-tool":return{args:x?{...w,function_call:{name:e.tool.name},functions:[{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters}]}:{...w,tool_choice:{type:"function",function:{name:e.tool.name}},tools:[{type:"function",function:{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters,strict:this.settings.structuredOutputs===!0?!0:void 0}}]},warnings:C};default:{const M=S;throw new Error(`Unsupported type: ${M}`)}}}async doGenerate(e){var s,t,n,r,a,i,o,l,m,y,h,p,c,u,g,v,b,k;const{args:S,warnings:C}=this.getArgs(e),{responseHeaders:x,value:w}=await L({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:F(this.config.headers(),e.headers),body:S,failedResponseHandler:U,successfulResponseHandler:fe(Ht),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:M,...D}=S,O=w.choices[0];let q;return(((t=(s=w.usage)==null?void 0:s.completion_tokens_details)==null?void 0:t.reasoning_tokens)!=null||((r=(n=w.usage)==null?void 0:n.prompt_tokens_details)==null?void 0:r.cached_tokens)!=null)&&(q={openai:{}},((i=(a=w.usage)==null?void 0:a.completion_tokens_details)==null?void 0:i.reasoning_tokens)!=null&&(q.openai.reasoningTokens=(l=(o=w.usage)==null?void 0:o.completion_tokens_details)==null?void 0:l.reasoning_tokens),((y=(m=w.usage)==null?void 0:m.prompt_tokens_details)==null?void 0:y.cached_tokens)!=null&&(q.openai.cachedPromptTokens=(p=(h=w.usage)==null?void 0:h.prompt_tokens_details)==null?void 0:p.cached_tokens)),{text:(c=O.message.content)!=null?c:void 0,toolCalls:this.settings.useLegacyFunctionCalling&&O.message.function_call?[{toolCallType:"function",toolCallId:B(),toolName:O.message.function_call.name,args:O.message.function_call.arguments}]:(u=O.message.tool_calls)==null?void 0:u.map(J=>{var H;return{toolCallType:"function",toolCallId:(H=J.id)!=null?H:B(),toolName:J.function.name,args:J.function.arguments}}),finishReason:Y(O.finish_reason),usage:{promptTokens:(v=(g=w.usage)==null?void 0:g.prompt_tokens)!=null?v:NaN,completionTokens:(k=(b=w.usage)==null?void 0:b.completion_tokens)!=null?k:NaN},rawCall:{rawPrompt:M,rawSettings:D},rawResponse:{headers:x},response:Q(w),warnings:C,logprobs:Ee(O.logprobs),providerMetadata:q}}async doStream(e){if(Ie(this.modelId)){const u=await this.doGenerate(e);return{stream:new ReadableStream({start(v){if(v.enqueue({type:"response-metadata",...u.response}),u.text&&v.enqueue({type:"text-delta",textDelta:u.text}),u.toolCalls)for(const b of u.toolCalls)v.enqueue({type:"tool-call",...b});v.enqueue({type:"finish",finishReason:u.finishReason,usage:u.usage,logprobs:u.logprobs,providerMetadata:u.providerMetadata}),v.close()}}),rawCall:u.rawCall,rawResponse:u.rawResponse,warnings:u.warnings}}const{args:s,warnings:t}=this.getArgs(e),{responseHeaders:n,value:r}=await L({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:F(this.config.headers(),e.headers),body:{...s,stream:!0,stream_options:this.config.compatibility==="strict"?{include_usage:!0}:void 0},failedResponseHandler:U,successfulResponseHandler:Xe(Vt),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:a,...i}=s,o=[];let l="unknown",m={promptTokens:void 0,completionTokens:void 0},y,h=!0;const{useLegacyFunctionCalling:p}=this.settings;let c;return{stream:r.pipeThrough(new TransformStream({transform(u,g){var v,b,k,S,C,x,w,M,D,O,q,J,H,ye,_e,be;if(!u.success){l="error",g.enqueue({type:"error",error:u.error});return}const P=u.value;if("error"in P){l="error",g.enqueue({type:"error",error:P.error});return}h&&(h=!1,g.enqueue({type:"response-metadata",...Q(P)})),P.usage!=null&&(m={promptTokens:(v=P.usage.prompt_tokens)!=null?v:void 0,completionTokens:(b=P.usage.completion_tokens)!=null?b:void 0},((k=P.usage.prompt_tokens_details)==null?void 0:k.cached_tokens)!=null&&(c={openai:{cachedPromptTokens:(S=P.usage.prompt_tokens_details)==null?void 0:S.cached_tokens}}));const j=P.choices[0];if(j?.finish_reason!=null&&(l=Y(j.finish_reason)),j?.delta==null)return;const V=j.delta;V.content!=null&&g.enqueue({type:"text-delta",textDelta:V.content});const Z=Ee(j?.logprobs);Z?.length&&(y===void 0&&(y=[]),y.push(...Z));const we=p&&V.function_call!=null?[{type:"function",id:B(),function:V.function_call,index:0}]:V.tool_calls;if(we!=null)for(const T of we){const G=T.index;if(o[G]==null){if(T.type!=="function")throw new ee({data:T,message:"Expected 'function' type."});if(T.id==null)throw new ee({data:T,message:"Expected 'id' to be a string."});if(((C=T.function)==null?void 0:C.name)==null)throw new ee({data:T,message:"Expected 'function.name' to be a string."});o[G]={id:T.id,type:"function",function:{name:T.function.name,arguments:(x=T.function.arguments)!=null?x:""}};const N=o[G];((w=N.function)==null?void 0:w.name)!=null&&((M=N.function)==null?void 0:M.arguments)!=null&&(N.function.arguments.length>0&&g.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:N.id,toolName:N.function.name,argsTextDelta:N.function.arguments}),ke(N.function.arguments)&&g.enqueue({type:"tool-call",toolCallType:"function",toolCallId:(D=N.id)!=null?D:B(),toolName:N.function.name,args:N.function.arguments}));continue}const $=o[G];((O=T.function)==null?void 0:O.arguments)!=null&&($.function.arguments+=(J=(q=T.function)==null?void 0:q.arguments)!=null?J:""),g.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:$.id,toolName:$.function.name,argsTextDelta:(H=T.function.arguments)!=null?H:""}),((ye=$.function)==null?void 0:ye.name)!=null&&((_e=$.function)==null?void 0:_e.arguments)!=null&&ke($.function.arguments)&&g.enqueue({type:"tool-call",toolCallType:"function",toolCallId:(be=$.id)!=null?be:B(),toolName:$.function.name,args:$.function.arguments})}},flush(u){var g,v;u.enqueue({type:"finish",finishReason:l,logprobs:y,usage:{promptTokens:(g=m.promptTokens)!=null?g:NaN,completionTokens:(v=m.completionTokens)!=null?v:NaN},...c!=null?{providerMetadata:c}:{}})}})),rawCall:{rawPrompt:a,rawSettings:i},rawResponse:{headers:n},warnings:t}}},Ze=f({prompt_tokens:_().nullish(),completion_tokens:_().nullish(),prompt_tokens_details:f({cached_tokens:_().nullish()}).nullish(),completion_tokens_details:f({reasoning_tokens:_().nullish()}).nullish()}).nullish(),Ht=f({id:d().nullish(),created:_().nullish(),model:d().nullish(),choices:E(f({message:f({role:se("assistant").nullish(),content:d().nullish(),function_call:f({arguments:d(),name:d()}).nullish(),tool_calls:E(f({id:d().nullish(),type:se("function"),function:f({name:d(),arguments:d()})})).nullish()}),index:_(),logprobs:f({content:E(f({token:d(),logprob:_(),top_logprobs:E(f({token:d(),logprob:_()}))})).nullable()}).nullish(),finish_reason:d().nullish()})),usage:Ze}),Vt=ge([f({id:d().nullish(),created:_().nullish(),model:d().nullish(),choices:E(f({delta:f({role:tt(["assistant"]).nullish(),content:d().nullish(),function_call:f({name:d().optional(),arguments:d().optional()}).nullish(),tool_calls:E(f({index:_(),id:d().nullish(),type:se("function").optional(),function:f({name:d().nullish(),arguments:d().nullish()})})).nullish()}).nullish(),logprobs:f({content:E(f({token:d(),logprob:_(),top_logprobs:E(f({token:d(),logprob:_()}))})).nullable()}).nullish(),finish_reason:d().nullable().optional(),index:_()})),usage:Ze}),ve]);function Bt({mode:e,useLegacyFunctionCalling:s=!1,structuredOutputs:t=!1}){var n;const r=(n=e.tools)!=null&&n.length?e.tools:void 0;if(r==null)return{tools:void 0,tool_choice:void 0};const a=e.toolChoice;if(s){const l=r.map(y=>({name:y.name,description:y.description,parameters:y.parameters}));if(a==null)return{functions:l,function_call:void 0};switch(a.type){case"auto":case"none":case void 0:return{functions:l,function_call:void 0};case"required":throw new A({functionality:"useLegacyFunctionCalling and toolChoice: required"});default:return{functions:l,function_call:{name:a.toolName}}}}const i=r.map(l=>({type:"function",function:{name:l.name,description:l.description,parameters:l.parameters,strict:t===!0?!0:void 0}}));if(a==null)return{tools:i,tool_choice:void 0};const o=a.type;switch(o){case"auto":case"none":case"required":return{tools:i,tool_choice:o};case"tool":return{tools:i,tool_choice:{type:"function",function:{name:a.toolName}}};default:{const l=o;throw new Error(`Unsupported tool choice type: ${l}`)}}}function Ie(e){return e.startsWith("o1-")}function Ft({prompt:e,inputFormat:s,user:t="user",assistant:n="assistant"}){if(s==="prompt"&&e.length===1&&e[0].role==="user"&&e[0].content.length===1&&e[0].content[0].type==="text")return{prompt:e[0].content[0].text};let r="";e[0].role==="system"&&(r+=`${e[0].content}

`,e=e.slice(1));for(const{role:a,content:i}of e)switch(a){case"system":throw new ut({message:"Unexpected system message in prompt: ${content}",prompt:e});case"user":{const o=i.map(l=>{switch(l.type){case"text":return l.text;case"image":throw new A({functionality:"images"})}}).join("");r+=`${t}:
${o}

`;break}case"assistant":{const o=i.map(l=>{switch(l.type){case"text":return l.text;case"tool-call":throw new A({functionality:"tool-call messages"})}}).join("");r+=`${n}:
${o}

`;break}case"tool":throw new A({functionality:"tool messages"});default:{const o=a;throw new Error(`Unsupported role: ${o}`)}}return r+=`${n}:
`,{prompt:r,stopSequences:[`
${t}:`]}}function Ce(e){return e?.tokens.map((s,t)=>({token:s,logprob:e.token_logprobs[t],topLogprobs:e.top_logprobs?Object.entries(e.top_logprobs[t]).map(([n,r])=>({token:n,logprob:r})):[]}))}var Lt=class{constructor(e,s,t){this.specificationVersion="v1",this.defaultObjectGenerationMode=void 0,this.modelId=e,this.settings=s,this.config=t}get provider(){return this.config.provider}getArgs({mode:e,inputFormat:s,prompt:t,maxTokens:n,temperature:r,topP:a,topK:i,frequencyPenalty:o,presencePenalty:l,stopSequences:m,responseFormat:y,seed:h}){var p;const c=e.type,u=[];i!=null&&u.push({type:"unsupported-setting",setting:"topK"}),y!=null&&y.type!=="text"&&u.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});const{prompt:g,stopSequences:v}=Ft({prompt:t,inputFormat:s}),b=[...v??[],...m??[]],k={model:this.modelId,echo:this.settings.echo,logit_bias:this.settings.logitBias,logprobs:typeof this.settings.logprobs=="number"?this.settings.logprobs:typeof this.settings.logprobs=="boolean"&&this.settings.logprobs?0:void 0,suffix:this.settings.suffix,user:this.settings.user,max_tokens:n,temperature:r,top_p:a,frequency_penalty:o,presence_penalty:l,seed:h,prompt:g,stop:b.length>0?b:void 0};switch(c){case"regular":{if((p=e.tools)!=null&&p.length)throw new A({functionality:"tools"});if(e.toolChoice)throw new A({functionality:"toolChoice"});return{args:k,warnings:u}}case"object-json":throw new A({functionality:"object-json mode"});case"object-tool":throw new A({functionality:"object-tool mode"});default:{const S=c;throw new Error(`Unsupported type: ${S}`)}}}async doGenerate(e){const{args:s,warnings:t}=this.getArgs(e),{responseHeaders:n,value:r}=await L({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:F(this.config.headers(),e.headers),body:s,failedResponseHandler:U,successfulResponseHandler:fe(Ut),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:a,...i}=s,o=r.choices[0];return{text:o.text,usage:{promptTokens:r.usage.prompt_tokens,completionTokens:r.usage.completion_tokens},finishReason:Y(o.finish_reason),logprobs:Ce(o.logprobs),rawCall:{rawPrompt:a,rawSettings:i},rawResponse:{headers:n},response:Q(r),warnings:t}}async doStream(e){const{args:s,warnings:t}=this.getArgs(e),{responseHeaders:n,value:r}=await L({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:F(this.config.headers(),e.headers),body:{...s,stream:!0,stream_options:this.config.compatibility==="strict"?{include_usage:!0}:void 0},failedResponseHandler:U,successfulResponseHandler:Xe(Dt),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:a,...i}=s;let o="unknown",l={promptTokens:Number.NaN,completionTokens:Number.NaN},m,y=!0;return{stream:r.pipeThrough(new TransformStream({transform(h,p){if(!h.success){o="error",p.enqueue({type:"error",error:h.error});return}const c=h.value;if("error"in c){o="error",p.enqueue({type:"error",error:c.error});return}y&&(y=!1,p.enqueue({type:"response-metadata",...Q(c)})),c.usage!=null&&(l={promptTokens:c.usage.prompt_tokens,completionTokens:c.usage.completion_tokens});const u=c.choices[0];u?.finish_reason!=null&&(o=Y(u.finish_reason)),u?.text!=null&&p.enqueue({type:"text-delta",textDelta:u.text});const g=Ce(u?.logprobs);g?.length&&(m===void 0&&(m=[]),m.push(...g))},flush(h){h.enqueue({type:"finish",finishReason:o,logprobs:m,usage:l})}})),rawCall:{rawPrompt:a,rawSettings:i},rawResponse:{headers:n},warnings:t}}},Ut=f({id:d().nullish(),created:_().nullish(),model:d().nullish(),choices:E(f({text:d(),finish_reason:d(),logprobs:f({tokens:E(d()),token_logprobs:E(_()),top_logprobs:E(xe(d(),_())).nullable()}).nullish()})),usage:f({prompt_tokens:_(),completion_tokens:_()})}),Dt=ge([f({id:d().nullish(),created:_().nullish(),model:d().nullish(),choices:E(f({text:d(),finish_reason:d().nullish(),index:_(),logprobs:f({tokens:E(d()),token_logprobs:E(_()),top_logprobs:E(xe(d(),_())).nullable()}).nullish()})),usage:f({prompt_tokens:_(),completion_tokens:_()}).nullish()}),ve]),Gt=class{constructor(e,s,t){this.specificationVersion="v1",this.modelId=e,this.settings=s,this.config=t}get provider(){return this.config.provider}get maxEmbeddingsPerCall(){var e;return(e=this.settings.maxEmbeddingsPerCall)!=null?e:2048}get supportsParallelCalls(){var e;return(e=this.settings.supportsParallelCalls)!=null?e:!0}async doEmbed({values:e,headers:s,abortSignal:t}){if(e.length>this.maxEmbeddingsPerCall)throw new ht({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});const{responseHeaders:n,value:r}=await L({url:this.config.url({path:"/embeddings",modelId:this.modelId}),headers:F(this.config.headers(),s),body:{model:this.modelId,input:e,encoding_format:"float",dimensions:this.settings.dimensions,user:this.settings.user},failedResponseHandler:U,successfulResponseHandler:fe(Kt),abortSignal:t,fetch:this.config.fetch});return{embeddings:r.data.map(a=>a.embedding),usage:r.usage?{tokens:r.usage.prompt_tokens}:void 0,rawResponse:{headers:n}}}},Kt=f({data:E(f({embedding:E(_())})),usage:f({prompt_tokens:_()}).nullish()});function zt(e={}){var s,t,n;const r=(t=qt((s=e.baseURL)!=null?s:e.baseUrl))!=null?t:"https://api.openai.com/v1",a=(n=e.compatibility)!=null?n:"compatible",i=()=>({Authorization:`Bearer ${Et({apiKey:e.apiKey,environmentVariableName:"OPENAI_API_KEY",description:"OpenAI"})}`,"OpenAI-Organization":e.organization,"OpenAI-Project":e.project,...e.headers}),o=(p,c={})=>new Jt(p,c,{provider:"openai.chat",url:({path:u})=>`${r}${u}`,headers:i,compatibility:a,fetch:e.fetch}),l=(p,c={})=>new Lt(p,c,{provider:"openai.completion",url:({path:u})=>`${r}${u}`,headers:i,compatibility:a,fetch:e.fetch}),m=(p,c={})=>new Gt(p,c,{provider:"openai.embedding",url:({path:u})=>`${r}${u}`,headers:i,fetch:e.fetch}),y=(p,c)=>{if(new.target)throw new Error("The OpenAI model function cannot be called with the new keyword.");return p==="gpt-3.5-turbo-instruct"?l(p,c):o(p,c)},h=function(p,c){return y(p,c)};return h.languageModel=y,h.chat=o,h.completion=l,h.embedding=m,h.textEmbedding=m,h.textEmbeddingModel=m,h}zt({compatibility:"strict"});export{zt as createOpenAI};
